<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>位置エネルギー実験：グラフ自動拡大版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; color: #fff; display: flex; }
        #sidebar { width: 360px; padding: 20px; background: #222; height: 100vh; overflow-y: auto; box-sizing: border-box; border-right: 2px solid #444; }
        #viewport { flex-grow: 1; height: 100vh; background: #000; }
        .card { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #bbb; }
        .val { font-weight: bold; color: #00d4ff; float: right; }
        input[type="range"] { width: 100%; margin-bottom: 10px; cursor: pointer; }
        button { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #btn-drop { background: #ff4757; color: white; }
        #btn-reset { background: #57606f; color: white; }
        .chart-container { background: white; padding: 10px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>実験設定</h2>
    <div class="card">
        <label>質量 (m): <span id="txt-mass" class="val">1.0</span> kg</label>
        <input type="range" id="range-mass" min="0.5" max="10.0" step="0.5" value="1.0">
        
        <label>高さ (h): <span id="txt-height" class="val">5.0</span> m</label>
        <input type="range" id="range-height" min="1.0" max="20.0" step="1.0" value="5.0">
        
        <button id="btn-drop">鉄球を落とす</button>
        <button id="btn-reset">リセット / グラフ消去</button>
    </div>

    <div class="chart-container">
        <canvas id="chartMass"></canvas>
    </div>

    <div class="chart-container">
        <canvas id="chartHeight"></canvas>
    </div>
</div>

<div id="viewport"></div>

<script>
// --- シミュレーション ---
let scene, camera, renderer, ball, target;
let isDropping = false;
let vel = 0;
const gravity = 0.02; 
const resistance = 30; // 抵抗値

function init() {
    const view = document.getElementById('viewport');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);
    camera = new THREE.PerspectiveCamera(45, view.clientWidth / view.clientHeight, 0.1, 1000);
    camera.position.set(15, 12, 15);
    camera.lookAt(0, 5, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(view.clientWidth, view.clientHeight);
    view.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(10, 20, 10);
    scene.add(sun);

    scene.add(new THREE.GridHelper(30, 30, 0x444444, 0x222222));

    // ターゲット（沈む円柱）
    target = new THREE.Mesh(
        new THREE.CylinderGeometry(0.8, 0.8, 2, 32),
        new THREE.MeshPhongMaterial({color: 0xffa500})
    );
    target.position.y = 1;
    scene.add(target);

    // 鉄球
    ball = new THREE.Mesh(
        new THREE.SphereGeometry(0.7, 32, 32),
        new THREE.MeshPhongMaterial({color: 0x999999, specular: 0xffffff})
    );
    scene.add(ball);

    updateParams();
}

// --- グラフ (Chart.js) ---
// y軸の「max: 15」などの固定を削除し、beginAtZero: true のみにします
function getChartConfig(title, xLabel) {
    return {
        type: 'scatter',
        data: { datasets: [{ label: 'データ', data: [], backgroundColor: '#3498db' }] },
        options: {
            plugins: { title: { display: true, text: title }, legend: { display: false } },
            scales: {
                x: { type: 'linear', title: { display: true, text: xLabel } },
                y: { beginAtZero: true, title: { display: true, text: '沈み込み (cm)' } } // 自動スケール
            }
        }
    };
}

const chartMass = new Chart(document.getElementById('chartMass'), getChartConfig('質量と沈み込みの関係', '質量 (kg)'));
const chartHeight = new Chart(document.getElementById('chartHeight'), getChartConfig('高さと沈み込みの関係', '高さ (m)'));

// --- 操作ロジック ---
const inMass = document.getElementById('range-mass');
const inHeight = document.getElementById('range-height');

function updateParams() {
    const m = parseFloat(inMass.value);
    const h = parseFloat(inHeight.value);
    document.getElementById('txt-mass').innerText = m.toFixed(1);
    document.getElementById('txt-height').innerText = h.toFixed(1);
    
    ball.scale.set(0.5 + m*0.1, 0.5 + m*0.1, 0.5 + m*0.1);
    if (!isDropping) {
        ball.position.set(0, h + 3, 0);
        target.position.y = 1;
    }
}

inMass.oninput = updateParams;
inHeight.oninput = updateParams;

document.getElementById('btn-drop').onclick = () => {
    if(isDropping) return;
    isDropping = true;
    vel = 0;
};

document.getElementById('btn-reset').onclick = () => {
    isDropping = false;
    chartMass.data.datasets[0].data = [];
    chartHeight.data.datasets[0].data = [];
    chartMass.update();
    chartHeight.update();
    updateParams();
};

function animate() {
    requestAnimationFrame(animate);
    if (isDropping) {
        vel += gravity;
        ball.position.y -= vel;

        if (ball.position.y <= target.position.y + 1.3) {
            isDropping = false;
            const m = parseFloat(inMass.value);
            const h = parseFloat(inHeight.value);
            const energy = m * 9.8 * h;
            const sink = energy / resistance;

            target.position.y -= (sink * 0.1); 
            
            chartMass.data.datasets[0].data.push({x: m, y: sink});
            chartHeight.data.datasets[0].data.push({x: h, y: sink});
            chartMass.update();
            chartHeight.update();
        }
    }
    renderer.render(scene, camera);
}

init();
animate();

window.onresize = () => {
    const v = document.getElementById('viewport');
    camera.aspect = v.clientWidth / v.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(v.clientWidth, v.clientHeight);
};
</script>
</body>
</html>
