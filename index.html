<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>位置エネルギー実験シミュレーター (2連グラフ版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; display: flex; }
        #ui-panel { width: 350px; padding: 20px; background: rgba(30,30,30,0.95); z-index: 10; height: 100vh; overflow-y: auto; box-sizing: border-box; border-right: 1px solid #444; }
        #canvas-container { flex-grow: 1; position: relative; }
        .control-group { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 8px; color: #ddd; }
        input[type="range"] { width: 100%; cursor: pointer; }
        button { width: 100%; padding: 12px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        button:hover { background: #218838; }
        .stats { font-family: monospace; background: #000; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #007bff; }
        .chart-container { background: white; margin-top: 15px; border-radius: 8px; padding: 10px; }
        h3 { font-size: 1rem; margin-top: 0; color: #fff; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .chart-label { color: #333; font-size: 0.8rem; font-weight: bold; text-align: center; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h3>実験コントロール</h3>
    <div class="control-group">
        <label>鉄球の質量 ($m$): <span id="val-mass">1.0</span> kg</label>
        <input type="range" id="input-mass" min="0.5" max="5.0" step="0.5" value="1.0">
    </div>
    <div class="control-group">
        <label>落とす高さ ($h$): <span id="val-height">5.0</span> m</label>
        <input type="range" id="input-height" min="1.0" max="10.0" step="0.5" value="5.0">
    </div>
    
    <button id="btn-drop">鉄球を落とす</button>
    <button id="btn-reset" style="margin-top:10px; background:#6c757d;">リセット</button>

    <div class="stats">
        <div>推定エネルギー: <span id="stat-pe">0</span> J</div>
        <div>沈み込み距離: <span id="stat-sink">0</span> cm</div>
    </div>

    <div class="chart-container">
        <div class="chart-label">高さ $h$ と沈み込みの関係</div>
        <canvas id="chartHeight" width="300" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 20px;">
        <div class="chart-label">質量 $m$ と沈み込みの関係</div>
        <canvas id="chartMass" width="300" height="200"></canvas>
    </div>
</div>

<div id="canvas-container"></div>

<script>
// --- 物理定数 ---
const g = 9.8; 
const k = 40; // 沈み込み係数

// --- Three.js セットアップ ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222222);
const camera = new THREE.PerspectiveCamera(60, (window.innerWidth - 350) / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth - 350, window.innerHeight);
document.getElementById('canvas-container').appendChild(renderer.domElement);

// 照明
const light1 = new THREE.DirectionalLight(0xffffff, 1);
light1.position.set(5, 10, 7);
scene.add(light1);
scene.add(new THREE.AmbientLight(0x606060));

// ステージ作成
const floor = new THREE.Mesh(new THREE.GridHelper(20, 20, 0x444444, 0x333333));
scene.add(floor);

// 筒
const tube = new THREE.Mesh(
    new THREE.CylinderGeometry(0.7, 0.7, 5, 32, 1, true),
    new THREE.MeshPhongMaterial({color: 0x00ccff, transparent: true, opacity: 0.2, side: THREE.DoubleSide})
);
tube.position.y = 2.5;
scene.add(tube);

// 円柱ターゲット
const target = new THREE.Mesh(
    new THREE.CylinderGeometry(0.6, 0.6, 3, 32),
    new THREE.MeshPhongMaterial({color: 0xffaa00})
);
target.position.y = 1.5; 
scene.add(target);

// 鉄球
const ball = new THREE.Mesh(
    new THREE.SphereGeometry(0.5, 32, 32),
    new THREE.MeshPhongMaterial({color: 0xcccccc, specular: 0xffffff, shininess: 100})
);
scene.add(ball);

camera.position.set(0, 8, 15);
camera.lookAt(0, 3, 0);

// --- グラフ初期化 (Chart.js) ---
const commonOptions = (xLabel) => ({
    scales: {
        x: { type: 'linear', position: 'bottom', title: { display: true, text: xLabel } },
        y: { title: { display: true, text: '沈み込み (cm)' }, min: 0, max: 15 }
    },
    plugins: { legend: { display: false } }
});

const chartHeight = new Chart(document.getElementById('chartHeight'), {
    type: 'scatter',
    data: { datasets: [{ label: 'h vs distance', data: [], backgroundColor: '#ff4444' }] },
    options: commonOptions('高さ h (m)')
});

const chartMass = new Chart(document.getElementById('chartMass'), {
    type: 'scatter',
    data: { datasets: [{ label: 'm vs distance', data: [], backgroundColor: '#4444ff' }] },
    options: commonOptions('質量 m (kg)')
});

// --- ロジック ---
let dropping = false;
let velocity = 0;
const massInput = document.getElementById('input-mass');
const heightInput = document.getElementById('input-height');

function updateParams() {
    const m = parseFloat(massInput.value);
    const h = parseFloat(heightInput.value);
    document.getElementById('val-mass').innerText = m;
    document.getElementById('val-height').innerText = h;
    
    ball.scale.set(0.6 + m*0.15, 0.6 + m*0.15, 0.6 + m*0.15);
    if(!dropping) {
        ball.position.y = h + 3.2; // 初期位置
    }
    document.getElementById('stat-pe').innerText = (m * g * h).toFixed(1);
}

massInput.oninput = updateParams;
heightInput.oninput = updateParams;
updateParams();

document.getElementById('btn-drop').onclick = () => {
    if(dropping) return;
    dropping = true;
    velocity = 0;
};

document.getElementById('btn-reset').onclick = () => {
    dropping = false;
    velocity = 0;
    target.position.y = 1.5;
    updateParams();
};

function animate() {
    requestAnimationFrame(animate);
    if (dropping) {
        velocity += 0.02; 
        ball.position.y -= velocity;

        if (ball.position.y <= target.position.y + 1.5) {
            dropping = false;
            const m = parseFloat(massInput.value);
            const h = parseFloat(heightInput.value);
            const energy = m * g * h;
            const sinkDist = energy / k; // 物理モデルに基づいた沈み込み

            target.position.y -= (sinkDist * 0.1); 
            document.getElementById('stat-sink').innerText = (sinkDist * 10).toFixed(2);

            // グラフへの記録
            chartHeight.data.datasets[0].data.push({x: h, y: sinkDist * 10});
            chartMass.data.datasets[0].data.push({x: m, y: sinkDist * 10});
            chartHeight.update();
            chartMass.update();
        }
    }
    renderer.render(scene, camera);
}
animate();

// ウィンドウリサイズ対応
window.addEventListener('resize', () => {
    camera.aspect = (window.innerWidth - 350) / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth - 350, window.innerHeight);
});
</script>
</body>
</html>
